name: Image Processing CI/CD

on: [push]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      pull-requests: write  # <--- THIS IS MISSING
      
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # --- ENHANCEMENT: CACHING ---
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker layers
      uses: actions/cache@v3
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Tools
      run: |
        pip install opencv-python-headless numpy pytest pytest-html sentry-sdk

    - name: Run Processor to Generate Files
      env:
        SENTRY_DSN: ${{ secrets.SENTRY_DSN }} # Injects Sentry DSN into the run
      run: |
        # Correct path for Milestone 1/2 structure
        export PYTHONPATH=$PYTHONPATH:.
        python src/processor.py 
        ls -R output/
        
    - name: Run Quality Tests
      run: |
        export PYTHONPATH=$PYTHONPATH:.
        pytest --html=report.html --self-contained-html

    - name: Save Automated Logs
      uses: actions/upload-artifact@v4
      with:
        name: quality-report-run-${{ github.run_number }}
        path: report.html

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # --- ENHANCEMENT: VULNERABILITY SCAN ---
    - name: Build Image for Scanning
      run: docker build -t ghcr.io/richtervhon/devops-midterm:latest .

    - name: Run Trivy Vulnerability Scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/richtervhon/devops-midterm:latest'
        format: 'table'
        exit-code: '0' # Stops the build if critical bugs are found
        severity: 'CRITICAL,HIGH'

    - name: Build and Push Docker Image
      if: github.ref == 'refs/heads/main' # Only push if logic is finalized on main
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ghcr.io/richtervhon/devops-midterm:latest
        build-args: |
          SENTRY_DSN=${{ secrets.SENTRY_DSN }}

    - name: Link Report in PR
      uses: mshick/add-pr-comment@v2
      if: always() && github.event_name == 'pull_request' # Runs even if tests fail
      with:
        message: |
          ## ðŸ§ª Milestone 4 Quality Report
          
          ðŸ“Š **Quality Test Report is ready!**
          To view the results:
          1. Click the link below.
          2. Scroll to the **Artifacts** section at the bottom.
          3. Download `quality-report-run-${{ github.run_number }}`.

          ðŸ”— [View Actions Run & Artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)