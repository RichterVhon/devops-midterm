name: Image Processing CI/CD

on: [push, pull_request]

jobs:
  # --- CHECK 1: LINTING (RESTORED) ---
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Lint with Flake8
        run: |
          pip install flake8
          # Stops the build if there are syntax errors
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

  # --- CHECK 2: BUILD, TEST, AND DEPLOY ---
  build-and-deploy:
    needs: quality-gate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      pull-requests: write 
      
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker layers
      uses: actions/cache@v3
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and Test inside Docker
      env:
        SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
      run: |
        # 1. Build the image
        docker build -t ghcr.io/richtervhon/devops-midterm:latest --build-arg SENTRY_DSN=$SENTRY_DSN .
        
        # 2. RUN PROCESSOR AND PYTEST
        # Added GITHUB_SHA so Sentry knows which version of the heater is running
        docker run --name test-container \
          -e SENTRY_DSN=$SENTRY_DSN \
          -e APP_ENV=production \
          -e GITHUB_SHA=${{ github.sha }} \
          ghcr.io/richtervhon/devops-midterm:latest \
          sh -c "python src/processor.py && pytest --html=report.html --self-contained-html"
        
        # 3. Copy the report out
        docker cp test-container:/app/report.html .

    - name: Run Trivy Vulnerability Scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/richtervhon/devops-midterm:latest'
        format: 'table'
        exit-code: '0' 
        severity: 'CRITICAL,HIGH'

    - name: Save Automated Logs
      uses: actions/upload-artifact@v4
      with:
        name: quality-report-run-${{ github.run_number }}
        path: report.html

    - name: Push Docker Image
      if: github.ref == 'refs/heads/main'
      run: docker push ghcr.io/richtervhon/devops-midterm:latest

    - name: Link Report in PR
      uses: mshick/add-pr-comment@v2
      if: always() && github.event_name == 'pull_request'
      with:
        message: |
          ## ðŸ§ª Milestone 4 Quality Report
          ðŸ“Š **Quality Test Report is ready!**
          ðŸ”— [View Actions Run & Artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)